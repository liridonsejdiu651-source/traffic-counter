<!doctype html>
<html lang="sq">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="description" content="Manual traffic counter (vehicles, bicycles, pedestrians) with charts, CSV export and iPhone PWA support." />
  <title>Manual Traffic Counter</title>

  <!-- PWA (iPhone / iPad / iOS) -->
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#0b63d1">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="Traffic Counter">
  <link rel="apple-touch-icon" href="icons/icon-192.png">

  <style>
    :root{--bg:#f6f8fb;--card:#fff;--muted:#666;--accent:#0b63d1}
    body{font-family:Inter, system-ui, Arial; margin:0; background:var(--bg); color:#111}
    header{background:var(--card); padding:12px 16px; box-shadow:0 1px 4px rgba(10,10,10,0.06); display:flex;align-items:center;gap:12px}
    header h1{font-size:18px;margin:0}
    .container{max-width:1100px;margin:18px auto;padding:12px}
    .controls{display:flex;gap:12px;flex-wrap:wrap;margin-bottom:12px}
    .card{background:var(--card);padding:12px;border-radius:10px;box-shadow:0 1px 4px rgba(10,10,10,0.04)}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .table-wrap{overflow:auto}
    table{border-collapse:collapse;width:100%}
    th,td{border:1px solid #e6e9ef;padding:8px;text-align:center}
    th{background:#fafbfd;color:var(--muted)}
    .btn{background:var(--accent);color:#fff;border:none;padding:8px 10px;border-radius:6px;cursor:pointer}
    .btn.secondary{background:#eee;color:#111}
    .number{font-weight:700;font-size:16px}
    .small{font-size:13px;color:var(--muted)}
    .log{max-height:220px;overflow:auto;padding:8px;background:#fff;border-radius:8px;border:1px solid #eee}
    .flex{display:flex;gap:8px;align-items:center}
    @media(min-width:900px){.grid{grid-template-columns:2fr 1fr}}

    /* Charts */
    #charts canvas{width:100%;height:240px;display:block}
  </style>

  <!-- IMPORTANT for GitHub Pages offline:
       Download Chart.js UMD build into ./vendor/chart.umd.js
       Folder structure in GitHub should include:
       /vendor/chart.umd.js
  -->
  <script defer src="./vendor/chart.umd.js"></script>
</head>
<body>
  <header>
    <h1>Manual Traffic Counter</h1>
    <div class="small">NumÃ«rim i thjeshtÃ« manual pÃ«r iOS/Android nÃ« shfletues</div>
  </header>

  <div class="container">

    <div class="controls">
      <div class="card" style="padding:10px;display:flex;gap:8px;align-items:center">
        <label class="small">Sesioni:</label>
        <input id="sessionName" placeholder="Emri i sesionit" />
        <button class="btn secondary" id="saveSessionBtn">Ruaj</button>
      </div>

      <div class="card" style="padding:10px;display:flex;gap:8px;align-items:center">
        <div class="flex">
          <button class="btn" id="startBtn">Start</button>
          <button class="btn secondary" id="stopBtn">Stop</button>
          <button class="btn secondary" id="resetBtn">Reset</button>
        </div>
        <div style="margin-left:12px" class="small">Koha: <span id="timer">00:00:00</span></div>
      </div>

      <div class="card" style="padding:10px;display:flex;gap:8px;align-items:center">
        <button class="btn" id="exportCsv">Export CSV</button>
        <button class="btn secondary" id="printBtn">Print</button>
        <button class="btn secondary" id="clearStorage">Clear LocalSave</button>
      </div>
    </div>

    <div class="grid">
      <div class="card table-wrap">
        <h3 style="margin-top:0">Tabela e numÃ«rimit</h3>
        <table id="countsTable">
          <thead>
            <tr>
              <th>Direction \\ Vehicle</th>
              <th>Car</th>
              <th>Truck</th>
              <th>Bus</th>
              <th>Motorcycle</th>
              <th>Bicycle</th>
              <th>Pedestrian</th>
              <th>Other</th>
              <th>Total</th>
            </tr>
          </thead>
          <tbody id="tableBody"></tbody>
          <tfoot>
            <tr>
              <th>Grand total</th>
              <th id="gt-car">0</th>
              <th id="gt-truck">0</th>
              <th id="gt-bus">0</th>
              <th id="gt-moto">0</th>
              <th id="gt-bicycle">0</th>
              <th id="gt-pedestrian">0</th>
              <th id="gt-other">0</th>
              <th id="gt-all">0</th>
            </tr>
          </tfoot>
        </table>
        <div class="small" style="margin-top:8px">Klikoni + pÃ«r tÃ« shtuar dhe - pÃ«r tÃ« hequr. Ruhet automatikisht nÃ« localStorage.</div>
      </div>

      <div class="card">
        <h3 style="margin-top:0">Log & Veprime</h3>
        <div class="log" id="log"></div>
      </div>
    </div>

    <!-- Data Summary Section -->
    <section id="data-summary" class="card" style="margin-top:12px">
      <h3 style="margin-top:0">Data Summary</h3>
      <p>Total Vehicles Counted: <span id="total-count">0</span></p>
      <p>Session Duration: <span id="session-duration">00:00:00</span></p>
      <button class="btn" onclick="exportCsv()">Export as CSV</button>
    </section>

    <!-- Charts Section -->
    <section id="charts" class="card" style="margin-top:12px">
      <h3 style="margin-top:0">Charts</h3>
      <div class="small" id="chartsHint" style="margin-bottom:8px"></div>
      <canvas id="barChart"></canvas>
      <div style="height:12px"></div>
      <canvas id="lineChart"></canvas>
      <div style="height:12px"></div>
      <canvas id="directionChart"></canvas>
    </section>

    <!-- Simple self-tests (open DevTools console to see results) -->
    <section class="card" style="margin-top:12px">
      <h3 style="margin-top:0">Self-tests</h3>
      <div class="small">KÃ«to teste ekzekutohen automatikisht nÃ« console. NÃ«se ndonjÃ« dÃ«shton, shfaqet si error.</div>
      <div class="small">(Nuk ndÃ«rhyjnÃ« nÃ« funksionimin e aplikacionit.)</div>
    </section>

  </div>

  <script>
    // ------------------------------
    // App configuration & state
    // ------------------------------
    const DIRECTIONS = ['North','South','East','West'];
    const VEHICLES = ['Car','Truck','Bus','Motorcycle','Bicycle','Pedestrian','Other'];

    let counts = {}; // counts[direction][vehicle]
    let running = false;
    let startTime = null;
    let timerInterval = null;

    // Charts state (must exist before updateDerivedUI calls updateCharts)
    let barChart = null;
    let lineChart = null;
    let directionChart = null;

    // ------------------------------
    // Helpers
    // ------------------------------
    function buildEmptyCounts(){
      const obj = {};
      DIRECTIONS.forEach(d=>{ obj[d] = {}; VEHICLES.forEach(v=> obj[d][v]=0); });
      return obj;
    }

    function safeGetEl(id){
      return document.getElementById(id);
    }

    // iOS/Safari sometimes ignores very fast click events on dynamically-created buttons.
    // Use event delegation so +/- always work.
    function bindTableClickDelegation(){
      const table = safeGetEl('countsTable');
      if (!table) return;
      table.addEventListener('click', (e)=>{
        const btn = e.target.closest('button[data-dir][data-veh][data-delta]');
        if (!btn) return;
        e.preventDefault();
        const dir = btn.getAttribute('data-dir');
        const veh = btn.getAttribute('data-veh');
        const delta = parseInt(btn.getAttribute('data-delta'),10);
        if (!dir || !veh || !Number.isFinite(delta)) return;
        adjustCount(dir, veh, delta);
      });
    }

    // ------------------------------
    // Rendering
    // ------------------------------
    function renderTable(){
      const tbody = safeGetEl('tableBody');
      tbody.innerHTML = '';

      DIRECTIONS.forEach(dir=>{
        const tr = document.createElement('tr');

        const th = document.createElement('th');
        th.textContent = dir;
        tr.appendChild(th);

        let rowTotal = 0;

        VEHICLES.forEach(v=>{
          const td = document.createElement('td');
          const wrap = document.createElement('div');
          wrap.style.display='flex';
          wrap.style.justifyContent='center';
          wrap.style.alignItems='center';
          wrap.style.gap='6px';

          const minus = document.createElement('button');
          minus.textContent='-';
          minus.className='btn secondary';
          minus.style.padding='6px 8px';
          minus.type = 'button';
          minus.setAttribute('data-dir', dir);
          minus.setAttribute('data-veh', v);
          minus.setAttribute('data-delta', '-1');

          const num = document.createElement('div');
          num.className='number';
          num.style.minWidth='36px';
          num.id = `count-${dir}-${v}`;
          num.textContent = counts[dir][v];

          const plus = document.createElement('button');
          plus.textContent='+';
          plus.className='btn';
          plus.style.padding='6px 8px';
          plus.type = 'button';
          plus.setAttribute('data-dir', dir);
          plus.setAttribute('data-veh', v);
          plus.setAttribute('data-delta', '1');

          wrap.appendChild(minus);
          wrap.appendChild(num);
          wrap.appendChild(plus);
          td.appendChild(wrap);
          tr.appendChild(td);

          rowTotal += counts[dir][v];
        });

        const totTd = document.createElement('td');
        totTd.textContent = rowTotal;
        totTd.id = `rowtotal-${dir}`;
        tr.appendChild(totTd);

        tbody.appendChild(tr);
      });
    }

    function updateTimerDisplay(){
      const timerEl = safeGetEl('timer');
      if (!startTime || !running){
        timerEl.textContent = '00:00:00';
        return;
      }
      const diff = Date.now() - startTime;
      const h = Math.floor(diff/3600000);
      const m = Math.floor((diff%3600000)/60000);
      const s = Math.floor((diff%60000)/1000);
      timerEl.textContent = `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
    }

    // ------------------------------
    // Totals + derived UI
    // ------------------------------
    function updateGrandTotals(){
      const totals = {Car:0,Truck:0,Bus:0,Motorcycle:0,Bicycle:0,Pedestrian:0,Other:0};
      let all = 0;

      DIRECTIONS.forEach(d=>{
        VEHICLES.forEach(v=>{
          totals[v] += counts[d][v];
          all += counts[d][v];
        });
      });

      safeGetEl('gt-car').textContent = totals.Car;
      safeGetEl('gt-truck').textContent = totals.Truck;
      safeGetEl('gt-bus').textContent = totals.Bus;
      safeGetEl('gt-moto').textContent = totals.Motorcycle;
      safeGetEl('gt-bicycle').textContent = totals.Bicycle;
      safeGetEl('gt-pedestrian').textContent = totals.Pedestrian;
      safeGetEl('gt-other').textContent = totals.Other;
      safeGetEl('gt-all').textContent = all;

      updateDerivedUI();
    }

    function updateDerivedUI(){
      // Data Summary
      const totalAll = parseInt(safeGetEl('gt-all')?.textContent || '0', 10);
      const tc = safeGetEl('total-count');
      if (tc) tc.textContent = String(totalAll);

      // Session duration
      const sd = safeGetEl('session-duration');
      if (sd){
        if (!startTime) {
          sd.textContent = '00:00:00';
        } else {
          const diff = (running ? (Date.now() - startTime) : 0);
          const secs = Math.max(0, Math.floor(diff/1000));
          const h = Math.floor(secs/3600);
          const m = Math.floor((secs%3600)/60);
          const s = secs%60;
          sd.textContent = `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
        }
      }

      // Charts
      updateCharts();
    }

    // ------------------------------
    // Hourly buckets (for trend)
    // ------------------------------
    function bucketKeyFor(dateObj){
      const y = dateObj.getFullYear();
      const m = String(dateObj.getMonth()+1).padStart(2,'0');
      const day = String(dateObj.getDate()).padStart(2,'0');
      const h = String(dateObj.getHours()).padStart(2,'0');
      return `${y}-${m}-${day} ${h}`;
    }

    function bucketKeyForNow(){
      return bucketKeyFor(new Date());
    }

    function addToHourlyBucket(delta){
      const raw = localStorage.getItem('manualCounterHourly') || '{}';
      const obj = JSON.parse(raw);
      const key = bucketKeyForNow();
      obj[key] = (obj[key] || 0) + delta;
      localStorage.setItem('manualCounterHourly', JSON.stringify(obj));
    }

    function getHourlySeries(){
      const raw = localStorage.getItem('manualCounterHourly') || '{}';
      const obj = JSON.parse(raw);
      const labels = [];
      const values = [];

      const now = new Date();
      for (let i=23; i>=0; i--){
        const d = new Date(now.getTime() - i*3600000);
        const key = bucketKeyFor(d);
        labels.push(`${String(d.getHours()).padStart(2,'0')}:00`);
        values.push(obj[key] || 0);
      }
      return {labels, values};
    }

    // ------------------------------
    // Charts (IMPORTANT: define BEFORE any call from updateDerivedUI)
    // ------------------------------
    function updateCharts(){
      const hint = safeGetEl('chartsHint');

      // If Chart.js not loaded (e.g. vendor/chart.umd.js missing), show a hint but do not throw.
      if (typeof window.Chart === 'undefined'){
        if (hint) hint.textContent = 'Chart.js mungon. Vendos ./vendor/chart.umd.js nÃ« GitHub pÃ«r grafikÃ« (ndryshe aplikacioni punon pa grafikÃ«).';
        return;
      }
      if (hint) hint.textContent = '';

      // Totals by vehicle
      const totalsByVehicle = VEHICLES.reduce((acc,v)=>{acc[v]=0; return acc;},{});
      DIRECTIONS.forEach(d=> VEHICLES.forEach(v=> totalsByVehicle[v] += counts[d][v]));
      const vLabels = Object.keys(totalsByVehicle);
      const vValues = Object.values(totalsByVehicle);

      // Totals by direction
      const totalsByDir = {};
      DIRECTIONS.forEach(d=>{ totalsByDir[d] = VEHICLES.reduce((s,v)=> s + counts[d][v], 0); });
      const dLabels = Object.keys(totalsByDir);
      const dValues = Object.values(totalsByDir);

      // Hourly trend
      const hourly = getHourlySeries();

      // Create/destroy charts safely
      const barCanvas = safeGetEl('barChart');
      const lineCanvas = safeGetEl('lineChart');
      const dirCanvas = safeGetEl('directionChart');

      if (barChart) barChart.destroy();
      barChart = new Chart(barCanvas, {
        type: 'bar',
        data: { labels: vLabels, datasets: [{ label: 'Total by vehicle type', data: vValues }] },
        options: { responsive: true, maintainAspectRatio: false }
      });

      if (lineChart) lineChart.destroy();
      lineChart = new Chart(lineCanvas, {
        type: 'line',
        data: { labels: hourly.labels, datasets: [{ label: 'Counts per hour (last 24h)', data: hourly.values }] },
        options: { responsive: true, maintainAspectRatio: false }
      });

      if (directionChart) directionChart.destroy();
      directionChart = new Chart(dirCanvas, {
        type: 'pie',
        data: { labels: dLabels, datasets: [{ label: 'By direction', data: dValues }] },
        options: { responsive: true, maintainAspectRatio: false }
      });
    }

    // ------------------------------
    // Actions
    // ------------------------------
    function adjustCount(direction, vehicle, delta){
      const before = counts[direction][vehicle];
      counts[direction][vehicle] = Math.max(0, counts[direction][vehicle] + delta);
      const actualDelta = counts[direction][vehicle] - before;

      safeGetEl(`count-${direction}-${vehicle}`).textContent = counts[direction][vehicle];

      const rowTotal = VEHICLES.reduce((s,v)=> s + counts[direction][v], 0);
      safeGetEl(`rowtotal-${direction}`).textContent = rowTotal;

      updateGrandTotals();

      if (actualDelta !== 0) {
        addToHourlyBucket(actualDelta);
        logAction(direction, vehicle, actualDelta);
      }

      saveState();
    }

    // Logging
    function logAction(direction, vehicle, delta){
      const el = safeGetEl('log');
      const now = new Date().toLocaleTimeString();
      const sign = delta>0?'+':'-';
      const line = document.createElement('div');
      line.textContent = `${now} â€” ${sign}${Math.abs(delta)} ${vehicle} (${direction})`;
      el.prepend(line);
    }

    // Timer
    function startTimer(){
      if (running) return;
      running = true;
      startTime = startTime || Date.now();
      timerInterval = setInterval(()=>{
        updateTimerDisplay();
        updateDerivedUI();
      }, 500);
      saveState();
    }

    function stopTimer(){
      running = false;
      clearInterval(timerInterval);
      timerInterval = null;
      updateDerivedUI();
      saveState();
    }

    function resetTimer(){
      startTime = null;
      updateTimerDisplay();
      updateDerivedUI();
      saveState();
    }

    // CSV export
    function exportCsv(){
      updateGrandTotals();

      const rows = [];
      const session = safeGetEl('sessionName').value || 'Session';
      rows.push(['Session', session]);
      rows.push(['Timestamp', new Date().toISOString()]);
      rows.push([]);
      rows.push(['Direction','Vehicle','Count']);
      DIRECTIONS.forEach(d=>{ VEHICLES.forEach(v=> rows.push([d,v,counts[d][v]])); });

      rows.push([]);
      rows.push(['Grand Totals','',safeGetEl('gt-all').textContent]);

      const csv = rows.map(r=> r.map(c=>`"${String(c).replace(/"/g,'""')}"`).join(',')).join('\n');
      const blob = new Blob([csv],{type:'text/csv'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `${session.replace(/\s+/g,'_')}_traffic_${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.csv`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    // Persistence
    function saveState(){
      const data = {
        counts,
        running,
        startTime,
        sessionName: safeGetEl('sessionName').value
      };
      localStorage.setItem('manualCounterState', JSON.stringify(data));
      // keep UI in sync but avoid recursion loops
      // (updateDerivedUI already calls updateCharts, which is now defined above)
      updateDerivedUI();
    }

    function clearLocalSave(){
      localStorage.removeItem('manualCounterState');
      localStorage.removeItem('manualCounterHourly');
      location.reload();
    }

    // Reset counts
    function resetCounts(){
      if(!confirm('Reset all counts?')) return;
      counts = buildEmptyCounts();
      renderTable();
      updateGrandTotals();
      // ensure counters are clickable
      updateDerivedUI();
      logAction('System','Reset',0);
      saveState();
    }

    // Print
    function printView(){ window.print(); }

    // ------------------------------
    // Self-tests (minimal)
    // ------------------------------
    function runSelfTests(){
      try {
        console.assert(Array.isArray(DIRECTIONS) && DIRECTIONS.length === 4, 'DIRECTIONS should have 4 items');
        console.assert(VEHICLES.includes('Pedestrian') && VEHICLES.includes('Bicycle'), 'VEHICLES should include Pedestrian and Bicycle');

        // test empty counts
        const tmp = buildEmptyCounts();
        console.assert(tmp.North && typeof tmp.North.Car === 'number', 'buildEmptyCounts should create nested numbers');

        // test hourly key
        const k = bucketKeyFor(new Date(2020,0,2,3,4,5));
        console.assert(k === '2020-01-02 03', 'bucketKeyFor formatting');

        console.log('[Self-tests] OK');
      } catch (e){
        console.error('[Self-tests] FAILED', e);
      }
    }

    // ------------------------------
    // Initialization
    // ------------------------------
    function init(){
      // bind delegation once
      bindTableClickDelegation();
      const saved = localStorage.getItem('manualCounterState');
      if (saved) {
        const data = JSON.parse(saved);
        counts = data.counts || buildEmptyCounts();
        running = false; // safety: never auto-run after reload
        startTime = data.startTime || null;
        safeGetEl('sessionName').value = data.sessionName || '';
      } else {
        counts = buildEmptyCounts();
      }

      renderTable();
      updateGrandTotals();
      updateTimerDisplay();
      runSelfTests();
    }

    // UI events
    safeGetEl('startBtn').addEventListener('click', startTimer);
    safeGetEl('stopBtn').addEventListener('click', stopTimer);
    safeGetEl('resetBtn').addEventListener('click', ()=>{ resetCounts(); resetTimer(); });
    safeGetEl('exportCsv').addEventListener('click', exportCsv);
    safeGetEl('printBtn').addEventListener('click', printView);
    safeGetEl('clearStorage').addEventListener('click', clearLocalSave);
    safeGetEl('saveSessionBtn').addEventListener('click', (e)=>{ e.preventDefault(); saveState(); });

    // Keyboard shortcuts (optional)
    document.addEventListener('keydown', (e)=>{
      const key = e.key;
      if (['1','2','3','4','5','6','7'].includes(key)){
        const idx = parseInt(key,10) - 1;
        const v = VEHICLES[idx];
        const dir = DIRECTIONS[0];
        if (v) adjustCount(dir, v, 1);
      }
    });

    // Wait until DOM is ready AND (optionally) Chart.js is loaded.
    // Even if Chart.js is slow/missing, updateCharts is already defined and safe.
    window.addEventListener('load', ()=>{
      init();
    });
  </script>

  <script>
    // PWA offline
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./service-worker.js');
      });
    }
  </script>

  <script>
    // iPhone banner: Add to Home Screen
    (function () {
      const isIOS = /iphone|ipad|ipod/i.test(navigator.userAgent);
      const isInStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone === true;
      if (!isIOS || isInStandalone) return;

      const banner = document.createElement('div');
      banner.style.cssText = 'position:fixed;left:12px;right:12px;bottom:12px;background:#fff;border:1px solid #e6e9ef;border-radius:12px;padding:12px;box-shadow:0 6px 20px rgba(0,0,0,.12);z-index:9999;';
      banner.innerHTML = `
        <div style="display:flex;gap:10px;align-items:flex-start;">
          <div style="font-size:18px;line-height:1;">ğŸ“±</div>
          <div style="flex:1">
            <div style="font-weight:700;margin-bottom:4px;">Hape si App nÃ« iPhone</div>
            <div style="font-size:13px;color:#666;">
              NÃ« Safari: <b>Share</b> (â¬†ï¸) â†’ <b>Add to Home Screen</b>.
            </div>
          </div>
          <button id="closeA2HS" style="border:none;background:#eee;border-radius:10px;padding:6px 10px;cursor:pointer;">Mbyll</button>
        </div>
      `;
      document.body.appendChild(banner);
      document.getElementById('closeA2HS').onclick = () => banner.remove();
    })();
  </script>
</body>
</html>
