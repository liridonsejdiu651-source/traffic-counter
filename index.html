<!DOCTYPE html>
<html lang="sq">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Traffic Counter</title>

  <!-- PWA -->
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#0d6efd">

  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 16px;
      background: #f5f5f5;
    }
    h2 { margin-top: 0; }
    table {
      width: 100%;
      border-collapse: collapse;
      background: #fff;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: center;
    }
    button {
      padding: 6px 12px;
      font-size: 16px;
    }
    .controls {
      display: flex;
      gap: 8px;
      justify-content: center;
    }
    canvas {
      margin-top: 20px;
      background: #fff;
      padding: 10px;
    }
  </style>
</head>

<body>

<h2>Numërimi i Trafikut</h2>

<table id="countsTable">
  <thead>
    <tr>
      <th>Kategoria</th>
      <th>Drejtimi</th>
      <th>Ora</th>
      <th>Numri</th>
      <th>Veprime</th>
    </tr>
  </thead>
  <tbody>
    <!-- Rreshtat -->
  </tbody>
</table>

<canvas id="trafficChart" height="220"></canvas>

<!-- Chart.js -->
<script src="./vendor/chart.umd.js"></script>

<script>
/* =============================
   TË DHËNAT
============================= */
const categories = [
  "Automjete",
  "Kamionë",
  "Autobusë",
  "Këmbësorë",
  "Biçiklistë"
];

const directions = ["A → B", "B → A"];

const dataStore = [];

/* =============================
   INICIALIZIMI
============================= */
const tbody = document.querySelector("#countsTable tbody");

categories.forEach(cat => {
  directions.forEach(dir => {
    const row = {
      category: cat,
      direction: dir,
      hour: new Date().getHours() + ":00",
      count: 0
    };
    dataStore.push(row);

    const tr = document.createElement("tr");
    tr.dataset.index = dataStore.length - 1;

    tr.innerHTML = `
      <td>${cat}</td>
      <td>${dir}</td>
      <td>${row.hour}</td>
      <td class="count">0</td>
      <td class="controls">
        <button type="button" data-action="minus">−</button>
        <button type="button" data-action="plus">+</button>
      </td>
    `;
    tbody.appendChild(tr);
  });
});

/* =============================
   EVENT DELEGATION (iOS SAFE)
============================= */
tbody.addEventListener("click", e => {
  const btn = e.target;
  if (!btn.dataset.action) return;

  const tr = btn.closest("tr");
  const index = tr.dataset.index;
  const row = dataStore[index];

  if (btn.dataset.action === "plus") row.count++;
  if (btn.dataset.action === "minus" && row.count > 0) row.count--;

  tr.querySelector(".count").textContent = row.count;
  updateCharts();
});

/* =============================
   chart.js
============================= */
let chart;

function updateCharts() {
  const summary = {};

  dataStore.forEach(r => {
    if (!summary[r.category]) summary[r.category] = 0;
    summary[r.category] += r.count;
  });

  const ctx = document.getElementById("trafficChart");

  if (chart) chart.destroy();

  chart = new Chart(ctx, {
    type: "bar",
    data: {
      labels: Object.keys(summary),
      datasets: [{
        label: "Numërimi total",
        data: Object.values(summary)
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { display: true }
      }
    }
  });
}

/* inicial */
updateCharts();

/* =============================
   SERVICE WORKER
============================= */
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("service-worker.js");
}
</script>

</body>
</html>
